
# ==============================================================
# Script: Remove older versions of Microsoft.RawImageExtension
# Logic: Only proceed if version 2.5.7.0 or higher is installed
# ==============================================================

$AppName = "*Microsoft.RawImage*"
$KeepVersion = [version]"2.5.7.0"

Write-Host "`n=== Checking for Microsoft.RawImageExtension v$KeepVersion or newer ===`n" -ForegroundColor Cyan

# Gather all installed and provisioned packages
$installedApps  = Get-AppxPackage -AllUsers | Where-Object { $_.Name -like $AppName }
$provisionedApps = Get-AppxProvisionedPackage -Online | Where-Object { $_.DisplayName -like $AppName }

# Determine if required version or higher exists
$hasRequiredVersion = $false

foreach ($pkg in $installedApps + $provisionedApps) {
    if ([version]$pkg.Version -ge $KeepVersion) {
        $hasRequiredVersion = $true
        break
    }
}

if (-not $hasRequiredVersion) {
    Write-Host "❌ No Microsoft.RawImageExtension version $KeepVersion or higher found. Aborting uninstallation." -ForegroundColor Red
    return
}

Write-Host "✅ Microsoft.RawImageExtension v$KeepVersion or newer detected. Proceeding with cleanup..." -ForegroundColor Green

# --- Step 1: Remove older installed Appx packages ---
foreach ($app in $installedApps) {
    $currentVersion = [version]$app.Version

    if ($currentVersion -lt $KeepVersion) {
        Write-Host "Removing $($app.Name) version $($app.Version) for user $($app.PackageUserInformation.UserSecurityId)" -ForegroundColor Yellow
        
        try {
            Remove-AppxPackage -Package $app.PackageFullName -AllUsers -ErrorAction Stop
            Write-Host "✅ Successfully removed $($app.PackageFullName)" -ForegroundColor Green
        }
        catch {
            Write-Host "❌ Failed to remove $($app.PackageFullName): $_" -ForegroundColor Red
        }
    }
    else {
        Write-Host "Skipping (Keeping) $($app.Name) version $($app.Version)" -ForegroundColor Gray
    }
}

# --- Step 2: Remove older provisioned Appx packages ---
foreach ($prov in $provisionedApps) {
    $provVersion = [version]$prov.Version

    if ($provVersion -lt $KeepVersion) {
        Write-Host "`nRemoving provisioned package $($prov.DisplayName) version $($prov.Version)" -ForegroundColor Yellow

        try {
            Remove-AppxProvisionedPackage -Online -PackageName $prov.PackageName -ErrorAction Stop | Out-Null
            Write-Host "✅ Successfully removed provisioned package $($prov.PackageName)" -ForegroundColor Green
        }
        catch {
            Write-Host "❌ Failed to remove provisioned package $($prov.PackageName): $_" -ForegroundColor Red
        }
    }
    else {
        Write-Host "Skipping (Keeping) provisioned package $($prov.DisplayName) version $($prov.Version)" -ForegroundColor Gray
    }
}

Write-Host "`n=== Cleanup complete ===`n" -ForegroundColor Cyan
